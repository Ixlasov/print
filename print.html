<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sotuv Chek</title>
    <style>
        /* --- SOZLAMALAR --- */
        @page {
            size: auto;
            margin: 0mm; /* Printer qog'ozini tejash uchun */
        }
        body {
            font-family: 'Courier New', Courier, monospace; /* Monospace - rasmiy chek shrifti */
            width: 74mm; /* 80mm printer uchun xavfsiz zona */
            margin: 0 auto;
            padding: 5px;
            background: #fff;
            color: #000;
            font-size: 13px; /* O'qishga qulay o'lcham */
            line-height: 1.3;
        }

        /* --- STYLES --- */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .bold { font-weight: bold; }
        
        /* Chiziqlar */
        .dashed-line {
            border-bottom: 1px dashed #000;
            margin: 6px 0;
            width: 100%;
            height: 1px;
        }
        .double-line {
            border-bottom: 3px double #000;
            margin: 6px 0;
        }

        /* Header */
        .store-name { font-size: 18px; font-weight: bold; text-transform: uppercase; margin-bottom: 4px; }
        .contact { font-size: 12px; }

        /* Sana va Mijoz qatori (Flexbox) */
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
        }
        .info-label { text-align: left; }
        .info-value { text-align: right; font-weight: bold; }

        /* Jadval */
        table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 13px; }
        th { border-bottom: 1px dashed #000; text-align: left; padding: 4px 0; }
        td { vertical-align: top; padding: 4px 0; }
        
        /* Jadval ustunlari kengligi */
        .col-num { width: 8%; text-align: left; }
        .col-name { width: 52%; text-align: left; padding-right: 2px; }
        .col-data { width: 40%; text-align: right; }

        /* Yig'indilar */
        .totals-section { margin-top: 5px; }
        .total-row { display: flex; justify-content: space-between; margin-bottom: 2px; }
        .grand-total { font-size: 18px; font-weight: bold; padding: 5px 0; border-top: 1px dashed #000; border-bottom: 1px dashed #000; margin: 5px 0; }
        
        /* Footer statistikasi */
        .stats-footer {
            text-align: center;
            font-size: 12px;
            margin-top: 5px;
            font-style: italic;
        }

        /* Print tugmasi */
        #printBtn {
            display: block; width: 100%; padding: 15px; margin-top: 20px;
            background: #000; color: #fff; border: none; font-size: 16px; cursor: pointer;
        }
        @media print {
            #printBtn { display: none; }
        }
    </style>
</head>
<body>

    <!-- HEADER -->
    <div class="text-center">
        <div class="store-name" id="storeName">DO'KON NOMI</div>
        <div class="contact" id="storeInfo">
            Manzil: Toshkent sh.<br>
            Tel: +998 90 123-45-67
        </div>
    </div>

    <div class="double-line"></div>

    <!-- SANA VA MIJOZ (Talab 1: Qiymat o'ngda va qalin) -->
    <div class="info-row">
        <span class="info-label">Sana:</span>
        <span class="info-value" id="tDate">...</span>
    </div>
    <div class="info-row">
        <span class="info-label">Chek â„–:</span>
        <span class="info-value" id="tId">...</span>
    </div>
    <div class="info-row">
        <span class="info-label">Mijoz:</span>
        <span class="info-value" id="tClient">...</span>
    </div>

    <div class="dashed-line"></div>

    <!-- MAHSULOTLAR JADVALI -->
    <table>
        <thead>
            <tr>
                <th class="col-num">#</th>
                <th class="col-name">Nomi</th>
                <th class="col-data">Soni x Narx<br>= Jami</th>
            </tr>
        </thead>
        <tbody id="itemsBody">
            <!-- JS to'ldiradi -->
        </tbody>
    </table>

    <div class="dashed-line"></div>
    <div class="stats-footer">
        Jami: <span id="statCount" class="bold">0</span> xil, 
        <span id="statQty" class="bold">0</span> ta mahsulot
    </div>
    <div class="dashed-line"></div>

    <!-- HISOB-KITOB -->
    <div class="totals-section">
        <div class="total-row">
            <span>Jami summa:</span>
            <span class="bold" id="tSubtotal">0</span>
        </div>
        <div class="total-row">
            <span>Chegirma:</span>
            <span id="tDiscount">0</span>
        </div>
        
        <div class="total-row grand-total">
            <span>TO'LOV:</span>
            <span id="tTotal">0</span>
        </div>

        <div class="total-row">
            <span>To'landi:</span>
            <span id="tPaid">0</span>
        </div>
        <div class="total-row">
            <span>Qarz:</span>
            <span class="bold" id="tDebt">0</span>
        </div>
    </div>

    <!-- STATISTIKA (Talab 3: Nechta mahsulot va umumiy qty) -->
    <div class="dashed-line"></div>

    <div class="text-center" style="margin-top: 15px; margin-bottom: 20px;">
        *** Xaridingiz uchun rahmat! ***
    </div>

    <button id="printBtn" onclick="window.print()">CHOP ETISH</button>

    <script>
        // 1000 lik ajratgich funksiyasi (12 000 ko'rinishida)
        function fmt(num) {
            if(!num && num !== 0) return "0";
            return parseFloat(num).toLocaleString('uz-UZ').replace(/,/g, " ");
        }

        const params = new URLSearchParams(window.location.search);
        const rawItems = params.get('items');

        // Do'kon ma'lumotlari
        if(params.get('store')) document.getElementById('storeName').innerText = params.get('store');
        if(params.get('phone')) document.getElementById('storeInfo').innerHTML = (params.get('addr') || "") + "<br>" + "Tel: " + params.get('phone');

        // Asosiy ma'lumotlar
        document.getElementById('tDate').innerText = params.get('date') || new Date().toLocaleString();
        document.getElementById('tId').innerText = params.get('id') || "---";
        document.getElementById('tClient').innerText = params.get('client') || "Noma'lum";

        // Summalar
        document.getElementById('tSubtotal').innerText = fmt(params.get('subtotal'));
        document.getElementById('tDiscount').innerText = fmt(params.get('discount'));
        document.getElementById('tTotal').innerText = fmt(params.get('total'));
        document.getElementById('tPaid').innerText = fmt(params.get('paid'));
        document.getElementById('tDebt').innerText = fmt(params.get('debt'));

        // Jadvalni to'ldirish
        const tbody = document.getElementById('itemsBody');
        let totalQty = 0;
        let distinctItems = 0;

        if (rawItems) {
            const rows = rawItems.split('~');
            
            rows.forEach((row, index) => { // 'index' bu yerda 0 dan boshlanadi
                if(row.trim()) {
                    const cols = row.split('|'); // Nom|Qty|Narx|Total
                    if(cols.length >= 4) {
                        const qty = parseFloat(cols[1]);
                        const price = parseFloat(cols[2]);
                        const total = parseFloat(cols[3]);
                        
                        // Statistikani hisoblash
                        totalQty += qty;
                        distinctItems++;

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td class="col-num">${distinctItems}</td> <!-- Talab 2: Avtomat raqam -->
                            <td class="col-name">${cols[0]}</td>
                            <td class="col-data">
                                ${qty} x ${fmt(price)}<br>
                                <span class="bold">=${fmt(total)}</span>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    }
                }
            });
            
            // Avtomatik chop etish
            setTimeout(() => window.print(), 800);
        } else {
            // TEST UCHUN (Agar ma'lumot kelmasa)
            tbody.innerHTML = `
                <tr><td class="col-num">1</td><td class="col-name">Test Tovar A</td><td class="col-data">2 x 10 000<br><b>=20 000</b></td></tr>
                <tr><td class="col-num">2</td><td class="col-name">Test Tovar B</td><td class="col-data">1 x 5 000<br><b>=5 000</b></td></tr>
            `;
            distinctItems = 2; totalQty = 3;
            document.getElementById('tTotal').innerText = "25 000";
        }

        // Statistikani chiqarish (Talab 3)
        document.getElementById('statCount').innerText = distinctItems;
        document.getElementById('statQty').innerText = totalQty;

    </script>
</body>
</html>
